{
  // === IDENTITY ===
  "id": "shopping-checkout",
  "version": "2.0.0",
  "initial": "browsing",

  // === DOMAIN TYPES ===
  "models": {
    "Product": {
      "type": "object",
      "properties": {
        "id": { "type": "string", "required": true },
        "name": { "type": "string", "required": true },
        "price": { "type": "number", "min": 0, "required": true },
        "inStock": { "type": "boolean" },
        "category": { "type": "string" }
      }
    },

    "CartItem": {
      "type": "object",
      "properties": {
        "productId": { "type": "string", "required": true },
        "quantity": { "type": "number", "min": 1, "required": true },
        "addedAt": { "type": "string" }
      }
    },

    "Address": {
      "type": "object",
      "properties": {
        "street": { "type": "string", "required": true },
        "city": { "type": "string", "required": true },
        "zipCode": { "type": "string", "required": true },
        "country": { "type": "string" }
      }
    },

    "PaymentMethod": {
      "type": "object",
      "properties": {
        "type": { "type": "string", "required": true },
        "last4": { "type": "string" }
      }
    }
  },

  // === SESSION STATE ===
  "data": {
    "products": {
      "type": "array",
      "items": { "$ref": "#/models/Product" },
      "default": []
    },

    "cart": {
      "type": "array",
      "items": { "$ref": "#/models/CartItem" },
      "default": []
    },

    "query": {
      "type": "string",
      "default": "",
      "maxLength": 100
    },

    "total": {
      "type": "number",
      "default": 0,
      "min": 0
    },

    "discount": {
      "type": "number",
      "default": 0,
      "min": 0,
      "max": 100
    },

    "shippingAddress": {
      "$ref": "#/models/Address",
      "required": false
    },

    "paymentMethod": {
      "$ref": "#/models/PaymentMethod",
      "required": false
    },

    "orderId": {
      "type": "string",
      "required": false
    },

    "retryCount": {
      "type": "number",
      "default": 0,
      "min": 0
    }
  },

  // === USER EVENTS ===
  "events": {
    "SEARCH": {
      "label": "Search products",
      "description": "Search the product catalog by keyword",
      "params": {
        "query": {
          "type": "string",
          "required": true,
          "minLength": 1,
          "maxLength": 100
        }
      }
    },

    "ADD_TO_CART": {
      "label": "Add to cart",
      "params": {
        "productId": { "type": "string", "required": true },
        "quantity": { "type": "number", "default": 1, "min": 1, "max": 99 }
      }
    },

    "REMOVE_FROM_CART": {
      "label": "Remove from cart",
      "params": {
        "productId": { "type": "string", "required": true }
      }
    },

    "CHECKOUT": {
      "label": "Proceed to checkout"
    },

    "SET_SHIPPING": {
      "label": "Set shipping address",
      "params": {
        "address": { "$ref": "#/models/Address", "required": true }
      }
    },

    "SET_PAYMENT": {
      "label": "Set payment method",
      "params": {
        "method": { "$ref": "#/models/PaymentMethod", "required": true }
      }
    },

    "PAY": {
      "label": "Complete payment"
    },

    "RETRY": {
      "label": "Retry"
    },

    "CANCEL": {
      "label": "Cancel"
    }
  },

  // === OPERATIONS (PROTOCOL CONTRACTS) ===
  "operations": {
    // --- SERVICE OPERATIONS (Async) ---

    "searchProducts": {
      "type": "service",
      "description": "Search product catalog",
      "input": {
        "type": "object",
        "properties": {
          "query": { "type": "string", "required": true }
        }
      },
      "output": {
        "type": "object",
        "properties": {
          "products": {
            "type": "array",
            "items": { "$ref": "#/models/Product" },
            "required": true
          }
        }
      },
      "metadata": {
        "intent": "product-search",
        "timeout": 5000,
        "cacheable": true
      }
    },

    "addToCartAPI": {
      "type": "service",
      "description": "Add item to cart on backend",
      "input": {
        "type": "object",
        "properties": {
          "productId": { "type": "string", "required": true },
          "quantity": { "type": "number", "required": true }
        }
      },
      "output": {
        "type": "object",
        "properties": {
          "cartItem": { "$ref": "#/models/CartItem" },
          "cartTotal": { "type": "number" }
        }
      }
    },

    "processPayment": {
      "type": "service",
      "description": "Process payment transaction",
      "input": {
        "type": "object",
        "properties": {
          "orderId": { "type": "string", "required": true },
          "amount": { "type": "number", "required": true },
          "paymentMethod": { "$ref": "#/models/PaymentMethod", "required": true }
        }
      },
      "output": {
        "type": "object",
        "properties": {
          "success": { "type": "boolean", "required": true },
          "transactionId": { "type": "string" }
        }
      },
      "metadata": {
        "timeout": 30000
      }
    },

    // --- ACTION OPERATIONS (Sync State Updates) ---

    "storeSearchResults": {
      "type": "action",
      "description": "Store search results in state",
      "input": {
        "type": "object",
        "properties": {
          "event": { "type": "object" }
        }
      },
      "output": {
        "type": "object",
        "properties": {
          "products": { "type": "array" },
          "query": { "type": "string" }
        }
      }
    },

    "addItemToCart": {
      "type": "action",
      "description": "Add item to local cart state",
      "input": { "type": "object" },
      "output": { "type": "object" }
    },

    "calculateTotal": {
      "type": "action",
      "description": "Calculate cart total with discounts",
      "input": { "type": "object" },
      "output": {
        "type": "object",
        "properties": {
          "total": { "type": "number" }
        }
      }
    },

    "storeShippingAddress": {
      "type": "action",
      "input": { "type": "object" },
      "output": { "type": "object" }
    },

    "storePaymentMethod": {
      "type": "action",
      "input": { "type": "object" },
      "output": { "type": "object" }
    },

    "incrementRetry": {
      "type": "action",
      "input": { "type": "object" },
      "output": {
        "type": "object",
        "properties": {
          "retryCount": { "type": "number" }
        }
      }
    },

    "logError": {
      "type": "action",
      "description": "Log error for debugging",
      "input": { "type": "object" },
      "output": { "type": "object" }
    },

    // --- GUARD OPERATIONS (Boolean Conditions) ---

    "hasQuery": {
      "type": "guard",
      "description": "Check if search query is provided",
      "input": { "type": "object" },
      "output": { "type": "boolean" }
    },

    "hasCartItems": {
      "type": "guard",
      "description": "Check if cart has items",
      "input": { "type": "object" },
      "output": { "type": "boolean" }
    },

    "canRetry": {
      "type": "guard",
      "description": "Check if retry limit not exceeded",
      "input": { "type": "object" },
      "output": { "type": "boolean" }
    }
  },

  // === STATE MACHINE ===
  "phases": {
    // --- Browsing ---
    "browsing": {
      "tags": ["interactive"],
      "on": {
        "SEARCH": {
          "target": "searching",
          "guard": "hasQuery"
        },
        "CHECKOUT": {
          "target": "reviewingCart",
          "guard": "hasCartItems"
        }
      }
    },

    // --- Searching ---
    "searching": {
      "tags": ["loading"],
      "invoke": {
        "src": "searchProducts",
        "input": "(data, event) => ({ query: event.query })",
        "onDone": {
          "target": "searchResults",
          "actions": "storeSearchResults"
        },
        "onError": {
          "target": "searchError",
          "actions": "logError"
        }
      }
    },

    "searchResults": {
      "tags": ["interactive"],
      "on": {
        "ADD_TO_CART": "addingToCart",
        "SEARCH": {
          "target": "searching",
          "guard": "hasQuery"
        },
        "CHECKOUT": {
          "target": "reviewingCart",
          "guard": "hasCartItems"
        }
      }
    },

    "searchError": {
      "tags": ["error"],
      "on": {
        "RETRY": "searching",
        "CANCEL": "browsing"
      }
    },

    // --- Cart Management ---
    "addingToCart": {
      "tags": ["loading"],
      "invoke": {
        "src": "addToCartAPI",
        "input": "(data, event) => ({ productId: event.productId, quantity: event.quantity || 1 })",
        "onDone": {
          "target": "searchResults",
          "actions": ["addItemToCart", "calculateTotal"]
        },
        "onError": {
          "target": "searchResults",
          "actions": "logError"
        }
      }
    },

    "reviewingCart": {
      "tags": ["interactive"],
      "entry": "calculateTotal",
      "on": {
        "REMOVE_FROM_CART": "removingFromCart",
        "CHECKOUT": {
          "target": "enteringShipping",
          "guard": "hasCartItems"
        },
        "CANCEL": "browsing"
      }
    },

    "removingFromCart": {
      "tags": ["loading"],
      "on": {
        "CANCEL": "reviewingCart"
      }
    },

    // --- Checkout Flow ---
    "enteringShipping": {
      "tags": ["interactive"],
      "on": {
        "SET_SHIPPING": {
          "target": "enteringPayment",
          "actions": "storeShippingAddress"
        },
        "CANCEL": "reviewingCart"
      }
    },

    "enteringPayment": {
      "tags": ["interactive"],
      "on": {
        "SET_PAYMENT": {
          "target": "confirmingOrder",
          "actions": "storePaymentMethod"
        },
        "CANCEL": "enteringShipping"
      }
    },

    "confirmingOrder": {
      "tags": ["interactive"],
      "on": {
        "PAY": "processingPayment",
        "CANCEL": "reviewingCart"
      }
    },

    // --- Payment Processing ---
    "processingPayment": {
      "tags": ["loading"],
      "invoke": {
        "src": "processPayment",
        "input": "(data) => ({ orderId: data.orderId, amount: data.total, paymentMethod: data.paymentMethod })",
        "onDone": [
          {
            "target": "paymentCompleted",
            "guard": "(data, event) => event.data.success === true"
          },
          {
            "target": "paymentFailed",
            "actions": "logError"
          }
        ],
        "onError": {
          "target": "paymentFailed",
          "actions": ["logError", "incrementRetry"]
        }
      }
    },

    "paymentFailed": {
      "tags": ["error"],
      "on": {
        "RETRY": [
          {
            "target": "processingPayment",
            "guard": "canRetry"
          },
          {
            "target": "maxRetriesExceeded"
          }
        ],
        "CANCEL": "reviewingCart"
      }
    },

    "maxRetriesExceeded": {
      "tags": ["error"],
      "on": {
        "CANCEL": "reviewingCart"
      }
    },

    // --- Final State ---
    "paymentCompleted": {
      "type": "final",
      "tags": ["success"]
    }
  }
}
